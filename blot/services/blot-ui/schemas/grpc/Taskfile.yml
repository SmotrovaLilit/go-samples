version: '3'

vars:
  PROTOC_IMAGE: '{{.PROTOC_IMAGE | default "protoc"}}'

tasks:
  # NOTE: Code generated by buf is not working. Hence, we generate it using protoc.
  generate:
    desc: Generate protobuf code
    vars:
      IMAGE_NAME: '{{.IMAGE_NAME | default "protoc"}}'
    cmds:
      - rm -rf generated
      - docker build -t {{.IMAGE_NAME}} -f protoc.dockerfile .
      - docker run -it --rm --user $(id -u):$(id -g) -v $(pwd):/work -w /work {{.IMAGE_NAME}} bash -c '
        mkdir generated &&
        protoc --ts_out="/work/generated" --ts_opt=use_proto_field_name --proto_path="/work" /work/blotservice/v1beta1/*.proto
        '
      - rm -rf ../../src/generated
      - mv generated ../../src/
